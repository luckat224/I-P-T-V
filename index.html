<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text to Image Upload</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-wrapper {
            position: relative;
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s;
        }

        .input-wrapper.drag-over {
            border-color: #4CAF50;
            background-color: #f0fff0;
        }

        .upload-hint {
            text-align: center;
            color: #999;
            padding: 10px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .upload-hint strong {
            color: #666;
        }

        .file-input-wrapper {
            text-align: center;
            margin-bottom: 10px;
        }

        .btn-choose-file {
            background-color: #FF9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-block;
        }

        .btn-choose-file:hover {
            background-color: #e68900;
        }

        input[type="file"] {
            display: none;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-family: Arial, sans-serif;
        }

        textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .preview-section {
            margin-bottom: 30px;
        }

        #preview {
            width: 100%;
            min-height: 300px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            color: black;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-preview {
            background-color: #2196F3;
            color: white;
        }

        .btn-preview:hover {
            background-color: #0b7dda;
        }

        .btn-upload {
            background-color: #4CAF50;
            color: white;
        }

        .btn-upload:hover {
            background-color: #45a049;
        }

        .btn-upload:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .result-section {
            display: none;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 2px solid #4CAF50;
        }

        .result-section.show {
            display: block;
        }

        .result-section h3 {
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .link-container {
            background: white;
            padding: 15px;
            border-radius: 5px;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .link-container a {
            color: #2196F3;
            text-decoration: none;
            font-weight: bold;
        }

        .link-container a:hover {
            text-decoration: underline;
        }

        .btn-copy {
            background-color: #FF9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-copy:hover {
            background-color: #e68900;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            display: none;
            padding: 15px;
            background-color: #ffebee;
            color: #c62828;
            border-radius: 5px;
            margin-top: 15px;
        }

        .error.show {
            display: block;
        }

        canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Text to Image Upload</h1>
        
        <div class="input-section">
            <h3>Nh·∫≠p ho·∫∑c d√°n vƒÉn b·∫£n c·ªßa b·∫°n:</h3>
            <div class="input-wrapper" id="inputWrapper">
                <div class="upload-hint">
                    <strong>üí° M·∫πo:</strong> K√©o th·∫£ h√¨nh ·∫£nh v√†o ƒë√¢y, ho·∫∑c click n√∫t b√™n d∆∞·ªõi ƒë·ªÉ ch·ªçn file
                </div>
                <div class="file-input-wrapper">
                    <label for="fileInput" class="btn-choose-file">üìÅ Ch·ªçn h√¨nh ·∫£nh t·ª´ m√°y</label>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <textarea id="textInput" placeholder="Ho·∫∑c d√°n vƒÉn b·∫£n c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
            </div>
        </div>


        <div class="button-group">
            <button class="btn-upload" id="uploadBtn" onclick="convertAndUpload()" disabled>üì§ Chuy·ªÉn ƒë·ªïi & Upload</button>
        </div>

        <div class="preview-section">
            <div id="preview">VƒÉn b·∫£n c·ªßa b·∫°n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</div>
        </div>

        <canvas id="canvas"></canvas>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ƒêang upload ·∫£nh...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="result-section" id="result">
            <h3>‚úÖ Upload th√†nh c√¥ng!</h3>
            <div class="link-container">
                <strong>Link ·∫£nh:</strong><br>
                <a id="imageLink" href="#" target="_blank"></a>
            </div>
            <button class="btn-copy" onclick="copyLink()">üìã Sao ch√©p link</button>
        </div>
    </div>

    <script>

        // ƒê·∫£m b·∫£o DOM ƒë√£ ƒë∆∞·ª£c t·∫£i xong
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });


        let currentText = '';
        let uploadedImageBlob = null;
        let uploadedImageDataUrl = null;

        function initApp() {
            const textInput = document.getElementById('textInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('fileInput');
            const inputWrapper = document.getElementById('inputWrapper');
            const preview = document.getElementById('preview');

            // L·∫Øng nghe s·ª± ki·ªán nh·∫≠p vƒÉn b·∫£n
            if (textInput) {
                textInput.addEventListener('input', function(e) {
                    currentText = e.target.value;
                    updatePreview();
                    uploadBtn.disabled = currentText.trim() === '' && !uploadedImageBlob;
                });
            }

            // X·ª≠ l√Ω ch·ªçn file
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        handleImageFile(file);
                    }
                });
            }

            // X·ª≠ l√Ω k√©o th·∫£
            if (inputWrapper) {
                inputWrapper.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    inputWrapper.classList.add('drag-over');
                });

                inputWrapper.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    inputWrapper.classList.remove('drag-over');
                });

                inputWrapper.addEventListener('drop', function(e) {
                    e.preventDefault();
                    inputWrapper.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type.startsWith('image/')) {
                        handleImageFile(files[0]);
                    }
                });
            }
        }

        // X·ª≠ l√Ω file h√¨nh ·∫£nh

        function handleImageFile(file) {
            uploadedImageBlob = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageDataUrl = e.target.result;
                updatePreview();
                document.getElementById('uploadBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // T·ª± ƒë·ªông c·∫≠p nh·∫≠t preview
        function updatePreview() {
            const preview = document.getElementById('preview');
            const text = currentText.trim();
            // Hi·ªÉn th·ªã text ·ªü tr√™n, ·∫£nh ·ªü d∆∞·ªõi n·∫øu c√≥ c·∫£ hai
            if (uploadedImageDataUrl && text) {
                preview.innerHTML = `<div style='margin-bottom:16px; font-size:32px; font-weight:bold; color:black; word-break:break-word;'>${escapeHtml(text).replace(/\n/g,'<br>')}</div><div><img src="${uploadedImageDataUrl}" style="max-width: 100%; max-height: 400px; object-fit: contain;"></div>`;
            } else if (uploadedImageDataUrl) {
                preview.innerHTML = `<img src="${uploadedImageDataUrl}" style="max-width: 100%; max-height: 400px; object-fit: contain;">`;
            } else if (text) {
                preview.innerHTML = `<div style='font-size:32px; font-weight:bold; color:black; word-break:break-word;'>${escapeHtml(text).replace(/\n/g,'<br>')}</div>`;
            } else {
                preview.textContent = 'VƒÉn b·∫£n c·ªßa b·∫°n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y';
            }
        }

        // Escape HTML ƒë·ªÉ tr√°nh l·ªói khi hi·ªÉn th·ªã text
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Chuy·ªÉn ƒë·ªïi vƒÉn b·∫£n th√†nh ·∫£nh
        function textToImage(text) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas 8K
            canvas.width = 7680;
            canvas.height = 4320;

            // V·∫Ω n·ªÅn tr·∫Øng
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Thi·∫øt l·∫≠p font ch·ªØ ƒëen, to, r√µ n√©t (tƒÉng size cho 8K)
            ctx.fillStyle = 'black';
            ctx.font = 'bold 240px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // Chia vƒÉn b·∫£n th√†nh nhi·ªÅu d√≤ng n·∫øu c·∫ßn
            const maxWidth = canvas.width - 600; // Padding 300px m·ªói b√™n
            const words = text.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const testLine = currentLine + ' ' + words[i];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);

            // V·∫Ω t·ª´ng d√≤ng vƒÉn b·∫£n ·ªü gi·ªØa
            const lineHeight = 300;
            const startY = (canvas.height - (lines.length - 1) * lineHeight) / 2;

            lines.forEach((line, index) => {
                ctx.fillText(line, canvas.width / 2, startY + (index * lineHeight));
            });

            return canvas;
        }

        // Chuy·ªÉn ƒë·ªïi canvas th√†nh blob
        function canvasToBlob(canvas) {
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/jpeg', 1.0); // Ch·∫•t l∆∞·ª£ng t·ªëi ƒëa
            });
        }

        // Upload ·∫£nh l√™n API
        async function uploadImage(blob) {
            const formData = new FormData();
            formData.append('images[]', blob, 'text-image.jpg');
            formData.append('server', 'server_1');
            
            const response = await fetch('https://cfig.ibytecdn.org/upload', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Upload failed: ' + response.statusText);
            }
            
            const result = await response.json();
            console.log('API Response:', result); // Debug: xem response t·ª´ server
            return result;
        }

        // Ch·ª©c nƒÉng ch√≠nh: Chuy·ªÉn ƒë·ªïi v√† upload

        async function convertAndUpload() {
            // N·∫øu c√≥ ·∫£nh th√¨ upload ·∫£nh, n·∫øu kh√¥ng th√¨ upload text th√†nh ·∫£nh
            if (uploadedImageBlob) {
                await uploadDirectImage();
            } else {
                await uploadTextAsImage();
            }
        }

        // Upload h√¨nh ·∫£nh tr·ª±c ti·∫øp
        async function uploadDirectImage() {
            // ·∫®n k·∫øt qu·∫£ c≈© v√† hi·ªÉn th·ªã loading
            document.getElementById('result').classList.remove('show');
            document.getElementById('error').classList.remove('show');
            document.getElementById('loading').classList.add('show');
            document.getElementById('uploadBtn').disabled = true;
            
            try {
                console.log('Uploading image directly:', uploadedImageBlob);
                
                // Upload ·∫£nh
                const result = await uploadImage(uploadedImageBlob);
                
                console.log('Upload result:', result);
                
                displayUploadResult(result);
                
            } catch (error) {
                console.error('Error:', error);
                showError('C√≥ l·ªói x·∫£y ra: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        // Upload vƒÉn b·∫£n d∆∞·ªõi d·∫°ng ·∫£nh
        async function uploadTextAsImage() {
            const text = document.getElementById('textInput').value.trim();
            
            if (text === '') {
                showError('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ho·∫∑c ch·ªçn h√¨nh ·∫£nh!');
                return;
            }
            
            // ·∫®n k·∫øt qu·∫£ c≈© v√† hi·ªÉn th·ªã loading
            document.getElementById('result').classList.remove('show');
            document.getElementById('error').classList.remove('show');
            document.getElementById('loading').classList.add('show');
            document.getElementById('uploadBtn').disabled = true;
            
            try {
                // Chuy·ªÉn ƒë·ªïi vƒÉn b·∫£n th√†nh ·∫£nh
                const canvas = textToImage(text);
                const blob = await canvasToBlob(canvas);
                
                console.log('Image blob created:', blob); // Debug
                
                // Upload ·∫£nh
                const result = await uploadImage(blob);
                
                console.log('Upload result:', result); // Debug
                
                displayUploadResult(result);
                
            } catch (error) {
                console.error('Error:', error);
                showError('C√≥ l·ªói x·∫£y ra: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ upload
        function displayUploadResult(result) {
            // X·ª≠ l√Ω nhi·ªÅu ƒë·ªãnh d·∫°ng response kh√°c nhau
            let imageUrl = null;
            
            // Th·ª≠ nhi·ªÅu c√°ch parse response
            if (result) {
                // C√°ch 1: result.results[0].url (API n√†y d√πng)
                if (result.results && Array.isArray(result.results) && result.results.length > 0) {
                    imageUrl = result.results[0].url || result.results[0].link || result.results[0].src;
                }
                // C√°ch 2: result.data[0].url
                else if (result.data && Array.isArray(result.data) && result.data.length > 0) {
                    imageUrl = result.data[0].url || result.data[0].link || result.data[0].src;
                }
                // C√°ch 3: result.url tr·ª±c ti·∫øp
                else if (result.url) {
                    imageUrl = result.url;
                }
                // C√°ch 4: result.link
                else if (result.link) {
                    imageUrl = result.link;
                }
                // C√°ch 5: result[0] n·∫øu result l√† array
                else if (Array.isArray(result) && result.length > 0) {
                    imageUrl = result[0].url || result[0].link || result[0];
                }
                // C√°ch 6: result.success v√† result.data
                else if (result.success && result.data) {
                    imageUrl = result.data.url || result.data.link || result.data;
                }
            }
            
            if (imageUrl) {
                document.getElementById('imageLink').href = imageUrl;
                document.getElementById('imageLink').textContent = imageUrl;
                document.getElementById('result').classList.add('show');
            } else {
                showError('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c link ·∫£nh t·ª´ server! Response: ' + JSON.stringify(result));
                console.error('Full response:', result);
            }
        }

        // Hi·ªÉn th·ªã l·ªói
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        // Sao ch√©p link
        function copyLink() {
            const link = document.getElementById('imageLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert('ƒê√£ sao ch√©p link v√†o clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
    </script>
</body>
</html>
